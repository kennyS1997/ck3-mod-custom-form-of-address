# IsValid() - whether title given as root is one of the vanity titles.
VNTL_sgui_is_vanity_title = {
	scope = title

	is_valid = {
		VNTL_is_vanity_title = yes
	}
}

# IsValid() - whether title given as root is a current (held) bound title
VNTL_sgui_is_current_bound_vanity_title = {
	scope = title

	is_valid = {
		VNTL_is_vanity_title = yes
		VNTL_is_vt_bound_current = yes
	}
}

# IsValid() - whether title given as root is a former (not held) bound title
VNTL_sgui_is_former_bound_vanity_title = {
	scope = title

	is_valid = {
		VNTL_is_vanity_title = yes
		VNTL_is_vt_bound_former = yes
	}
}

# IsValid() - whether title given as root is an unbound vanity title
VNTL_sgui_is_unbound_vanity_title = {
	scope = title

	is_valid = {
		VNTL_is_vanity_title = yes
		VNTL_is_vt_unbound = yes
	}
}

# IsValid() - whether character given as root holds a vanity title
VNTL_sgui_has_vanity_title = {
	scope = character

	is_valid = {
		VNTL_has_vanity_title = yes
	}
}

# Partial logic for "Edit FoA" button in window_title.gui .
# If necessary, this prepares vanity title and binds it to the primary title given as root.
# I.e. it selects available VT and makes the player its holder,
# sets VNTL_bound_vanity_title variable on the given primary title
# and sets VNTL_bound_primary_title variable on the VT.
# Actual opening of "Edit FoA" window (which is simply the rename window
# for bound vanity title with labels changed) is achieved
# via subsequent call to OpenTitleRenamePopup() in onclick action.
#
# IsShown() - visible for any player-held title.
# IsValid() - enabled only for player's primary title.
# Execute() - bind an available[1] vanity title to the given primary title.
#
# [1] For VT selection logic see VNTL_select_best_available_vanity_title_for_primary_title
# scripted effect, which this sgui's effect uses internally.
VNTL_sgui_bind_vanity_title = {
	scope = title

	saved_scopes = {
		player
	}

	is_shown = {
		exists = holder
		holder = scope:player
		#NOT = { has_variable = VNTL_bound_vanity_title }
	}

	is_valid = {
		scope:player = {
			primary_title = root
		}
	}

	effect = {
		holder = {
			# Find an available vanity title and bind it to this character's primary title.
			trigger_event = VNTL_events.1001
		}
	}
}

# Unbind and destroy the VT currently bound to the given primary title, if there is still such a bond.
# I.e. it clears VNTL_bound_vanity_title and destroys the VT it was pointing to.
# Note the reciprocal VNTL_bound_primary_title on the VT remains unchanged
# (this is so this same VT would be chosen first, should another attempt to bind a VT be made).
#
# IsValid() - enabled only for player's primary title.
# Execute() - unbind the VT (if currently bound) from the given primary title
VNTL_sgui_unbind_vanity_title = {
	scope = title

	saved_scopes = {
		player
	}

	is_shown = {
		exists = holder
		holder = scope:player
		#has_variable = VNTL_bound_vanity_title
	}

	is_valid = {
		scope:player = {
			primary_title = root
		}
	}

	effect = {
		holder = {
			# Unbind and destroy vanity title, if one is currently bound to this character's primary title.
			trigger_event = VNTL_events.1002
		}
	}
}

# Upholds mod invariants on primary title change.
# Destroys the VT bound to previously used primary title,
# re-creates the VT (if any) currently bound to the new primary title.
#
# Execute() - destroy any VTs which are bound to no-longer-primary titles,
#             re-create the VT bound to new primary title
#             (if there is a previously bound VT available).
VNTL_sgui_on_title_made_primary = {
	scope = title # The NEW primary title

	effect = {
		holder = {
			# There should only ever be 1 held VT at a time
			# but we'll use every_ in case something broke
			# due to incompatibility with other mods or something.
			every_held_title = {
				limit = {
					tier = tier_duchy
					VNTL_is_vanity_title = yes
					exists = var:VNTL_bound_primary_title
					NOT = { var:VNTL_bound_primary_title = root }
				}

				VNTL_try_destroy_title = yes
			}
		}

		# If there is an already bound and still available destroyed VT, re-create it.
		# This scenario is possible if, e.g. the player previously set up a VT
		# for their primary title, then had another title made primary
		# (at which point its VT got destroyed but remained bound),
		# and now their primary title is being changed back to the old one.
		# This logic ensures they get their original FoA back,
		# as long as their original VT is still available.
		if = {
			limit = {
				has_variable = VNTL_bound_vanity_title
			}

			var:VNTL_bound_vanity_title = {
				if = {
					limit = {
						NOT = { exists = holder }
						has_variable = VNTL_bound_primary_title
						var:VNTL_bound_primary_title = PREV
					}

					VNTL_give_vanity_title = {
						TARGET_CHARACTER = PREV.holder
						CHANGE_TYPE = created
					}
				}
			}
		}
	}
}
